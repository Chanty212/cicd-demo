pipeline {
  agent any

  environment {
    WEBEX_CRED_ID = 'webex-token'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Setup Python') {
      steps {
        bat '''
        python -m venv venv
        call venv\\Scripts\\activate
        pip install -r requirements.txt
        '''
      }
    }

    stage('Run Tests') {
      steps {
        bat '''
        call venv\\Scripts\\activate
        pytest -q
        '''
      }
    }
  }

  post {
    success {
      script {
        withCredentials([string(credentialsId: env.WEBEX_CRED_ID, variable: 'WEBEX_TOKEN')]) {
          bat """
          curl -X POST https://webexapis.com/v1/messages ^
               -H "Authorization: Bearer %WEBEX_TOKEN%" ^
               -H "Content-Type: application/json" ^
               -d "{\\"roomId\\":\\"Y2lzY29zcGFyazovL3VybjpURUFNOnVzLXdlc3QtMl9yL1JPT00vYmJiZDhmZjAtYzA0ZS0xMWYwLTgyNmMtYmIyN2IwZjdiOTM2\\",\\"text\\":\\"✅ Jenkins Build Success for %JOB_NAME% #%BUILD_NUMBER%\\"}"
          """
        }
      }
    }
    failure {
      script {
        withCredentials([string(credentialsId: env.WEBEX_CRED_ID, variable: 'WEBEX_TOKEN')]) {
          bat """
          curl -X POST https://webexapis.com/v1/messages ^
               -H "Authorization: Bearer %WEBEX_TOKEN%" ^
               -H "Content-Type: application/json" ^
               -d "{\\"roomId\\":\\"Y2lzY29zcGFyazovL3VybjpURUFNOnVzLXdlc3QtMl9yL1JPT00vYmJiZDhmZjAtYzA0ZS0xMWYwLTgyNmMtYmIyN2IwZjdiOTM2\\",\\"text\\":\\"❌ Jenkins Build FAILED for %JOB_NAME% #%BUILD_NUMBER%\\"}"
          """
        }
      }
    }
  }
}