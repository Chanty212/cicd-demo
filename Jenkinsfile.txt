pipeline {
    agent any

    environment {
        // Add any global environment variables here
        PYTHON_ENV = 'python3'
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Setup Python') {
            steps {
                sh '''
                    python3 --version
                    pip3 install --upgrade pip
                    pip3 install -r requirements.txt || echo "No requirements.txt found"
                '''
            }
        }

        stage('Run Tests') {
            steps {
                sh '''
                    echo "Running Python unit tests..."
                    python3 -m unittest discover || exit 1
                '''
            }
        }
    }

    post {
        success {
            script {
                withCredentials([string(credentialsId: 'webex-token', variable: 'WEBEX_TOKEN')]) {
                    sh '''
                        curl -X POST -H "Authorization: Bearer $WEBEX_TOKEN" \
                        -H "Content-Type: application/json" \
                        -d '{"roomId": "<YOUR_WEBEX_ROOM_ID>", "text": "Build SUCCESSFUL!"}' \
                        https://webexapis.com/v1/messages
                    '''
                }
            }
        }
        failure {
            script {
                withCredentials([string(credentialsId: 'webex-token', variable: 'WEBEX_TOKEN')]) {
                    sh '''
                        curl -X POST -H "Authorization: Bearer $WEBEX_TOKEN" \
                        -H "Content-Type: application/json" \
                        -d '{"roomId": "<YOUR_WEBEX_ROOM_ID>", "text": "Build FAILED!"}' \
                        https://webexapis.com/v1/messages
                    '''
                }
            }
        }
    }
}
